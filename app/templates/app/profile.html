{% extends "base.html" %}
{% block title %}Профиль пользователя{% endblock %}
{% load static %}

{% block content %}
<div class="main_container profile-main-container">

    {% if user.is_authenticated %}
        <div class="card profile-header-card">
            <div class="profile-avatar-wrapper">
                <a href="{% url 'image-list' %}" class="profile-avatar-link">
                    {% if profile.avatarlink %}
                        <img src="{% static 'app/img/' %}{{ profile.avatarlink }}"
                             alt="Avatar"
                             class="profile-avatar-img">
                    {% else %}
                        <img src="{% static 'app/img/default.png' %}" alt="No Avatar" class="profile-avatar-img profile-default-avatar-img">
                    {% endif %}
                </a>
            </div>

            <div class="profile-info-block">
                <h2 class="profile-username-title">{{ user.get_username }}</h2>
                <p class="profile-welcome-text">
                    Добро пожаловать в личный кабинет
                </p>
                {% if perms.app.worker %}
                    <a href="{% url 'admin_profile' %}" class="profile-worker-link">
                        ️ Войти в панель работника
                    </a>
                {% endif %}
            </div>

            <div class="profile-actions">
                <a href="{% url 'index' %}" class="btn-profile"> На главную</a>
                <a href="{% url 'to_logout' %}" class="btn-profile btn-logout"> Выйти</a>
            </div>
        </div>

        <div class="control-panel">

            <div class="control-panel-left">
                {% if perms.app.user and not perms.app.worker %}
                    <h2 class="app-list-title">Мои заявки</h2>
                    <a href="{% url 'create_new_application' %}"
                       class="btn-create-app">
                       + Создать новую заявку
                    </a>
                {% else %}
                    <h2>Заявки пользователей (Панель работника)</h2>
                {% endif %}
            </div>

            <div class="filter-wrapper">
                <p class="filter-title">Фильтрация по статусу:</p>
                <div class="filter-links-group">
                    <a href="{% url 'profile' %}" class="btn-profile btn-filter-app">Все</a>
                    <a href="{% url 'profile_filtered' status='n' %}" class="btn-profile btn-filter-app">Новые</a>
                    <a href="{% url 'profile_filtered' status='w' %}" class="btn-profile btn-filter-app">В работе</a>
                    <a href="{% url 'profile_filtered' status='c' %}" class="btn-profile btn-filter-app">Готовые</a>
                    <a href="{% url 'profile_filtered' status='r' %}" class="btn-profile btn-filter-app">Отклоненные</a>
                </div>
            </div>
        </div>

        <div class="cards_grid">
            {% if application_on_page %}
                {% for app in application_on_page %}
                    <a href="{{ app.get_absolute_url }}" style="text-decoration: none; color: inherit;">
                        <div class="card
                            {% if perms.app.worker %}
                                app-card-worker
                                {% if app.status == 'n' %} app-card-status-new {% endif %}
                            {% endif %}"
                            >

                            <div class="card_image_wrapper">
                                {% if app.image %}
                                    <img src="{{ app.image.url }}" alt="{{ app.title }}">
                                {% else %}
                                    <div class="app-card-no-photo">Нет фото</div>
                                {% endif %}
                                <span class="card_category_badge">{{ app.categories.category_full_name }}</span>
                            </div>

                            <div class="card_content">
                                <div class="card_header">
                                    <h3 class="card_title">{{ app.title }}</h3>
                                    <span class="card_date">{{ app.date }}</span>
                                    {% if perms.app.worker %}
                                        <p class="app-card-author-name">
                                            Автор: <strong>{{ app.user.username }}</strong>
                                        </p>
                                    {% endif %}
                                </div>

                                <div class="card_footer">
                                    <div class="status_indicator">
                                        <span class="status_label">Статус:</span>
                                        <span class="status_value status-value-text status-text-{{ app.status }}">
                                            {{ app.get_status_display }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </a>
                {% endfor %}
            {% else %}
                <div class="empty_state empty-state-full-width">
                    <p>Заявок не найдено.</p>
                </div>
            {% endif %}
        </div>

        {% if application_on_page.has_other_pages %}
        <div class="stats_bar pagination-bar">
            <div class="pagination-content">
                {% if application_on_page.has_previous %}
                    <a href="?page={{ application_on_page.previous_page_number }}" class="pagination-link">← Назад</a>
                {% endif %}

                <span class="pagination-current">
                    {{ application_on_page.number }} / {{ paginator.num_pages }}
                </span>

                {% if application_on_page.has_next %}
                    <a href="?page={{ application_on_page.next_page_number }}" class="pagination-link">Вперед →</a>
                {% endif %}
            </div>
        </div>
        {% endif %}

    {% else %}
        <div class="guest-container">
            <div class="card guest-card">
                <h2 class="guest-title">Требуется авторизация</h2>
                <p class="guest-text">
                    Для просмотра профиля и управления заявками необходимо войти в систему.
                </p>

                <div class="guest-auth-actions">
                    <a href="{% url 'login' %}" class="btn-guest-login">
                       Войти
                    </a>
                    <a href="{% url 'register' %}" class="btn-guest-register">
                       Зарегистрироваться
                    </a>
                </div>

                <div class="guest-footer">
                    <a href="{% url 'index' %}" class="guest-back-link">
                        ← Вернуться на главную
                    </a>
                </div>
            </div>
        </div>
    {% endif %}

</div>
{% endblock %}